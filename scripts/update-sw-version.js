import { readFileSync, writeFileSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const swPath = join(__dirname, '..', 'deploy', 'sw.js');
const versionPath = join(__dirname, '..', 'deploy', 'version.js');

// Read current sw.js
let swContent = readFileSync(swPath, 'utf-8');

// Generate version from timestamp
const version = Date.now().toString(36);

// Replace the version line
swContent = swContent.replace(
  /const CACHE_VERSION = '[^']*';/,
  `const CACHE_VERSION = '${version}';`
);

// Write back
writeFileSync(swPath, swContent);

// Generate version.js with ISO 8601 Zulu time deployment date
const deployDate = new Date().toISOString();
const versionContent = `// Auto-generated by build - do not edit
export const BUILD_VERSION = '${deployDate}';
`;
writeFileSync(versionPath, versionContent);

console.log(`SW cache version updated to: ${version}`);
console.log(`Build version: ${deployDate}`);
